import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { 
    getAuth, 
    signInWithEmailAndPassword, 
    onAuthStateChanged,
    createUserWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    getDoc,
    setDoc,
    collection,
    getDocs
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// ØªÙƒÙˆÙŠÙ† Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAZSMTIQ9o2Aqool263jkvVq-qzhEHEFfM",
    authDomain: "beautycenter-6e1cf.firebaseapp.com",
    projectId: "beautycenter-6e1cf",
    storageBucket: "beautycenter-6e1cf.firebasestorage.app",
    messagingSenderId: "706085429",
    appId: "1:706085429:web:1f0ce5d3eb27c35372277c",
    measurementId: "G-QL4LZG5KJZ"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
async function initializeFirstAdmin() {
    try {
        const usersSnapshot = await getDocs(collection(db, "users"));
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±
        if (usersSnapshot.empty) {
            console.log("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„...");
            
            const adminEmail = "admin@beautycenter.com";
            const adminPassword = "Admin123!";
            const adminName = "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…";
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, adminEmail, adminPassword);
                const user = userCredential.user;
                
                // Ø§Ø³ØªØ®Ø¯Ù… setDoc Ù…Ø¹ UID ÙƒÙ…ÙØªØ§Ø­ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† addDoc
                await setDoc(doc(db, "users", user.uid), {
                    name: adminName,
                    email: adminEmail,
                    role: "admin",
                    createdAt: new Date()
                });
                
                console.log("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹");
                console.log("ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:", adminEmail);
                console.log("ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:", adminPassword);
                
            } catch (authError) {
                if (authError.code === 'auth/email-already-in-use') {
                    console.log("âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©");
                    // Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Firestore
                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, adminEmail, adminPassword);
                        const user = userCredential.user;
                        
                        await setDoc(doc(db, "users", user.uid), {
                            name: adminName,
                            email: adminEmail,
                            role: "admin",
                            createdAt: new Date()
                        });
                        
                        console.log("âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Firestore");
                    } catch (signInError) {
                        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", signInError);
                    }
                } else {
                    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„:", authError);
                }
            }
        } else {
            console.log("âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²ØŒ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„ÙØ¹Ù„");
        }
    } catch (error) {
        console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
    }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    initializeFirstAdmin();
});

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯ÙˆØ±Ù‡
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                // ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                window.location.href = "main.html";
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
        }
    }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const messageDiv = document.getElementById('message');
    
    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const userDoc = await getDoc(doc(db, "users", user.uid));
        
        if (userDoc.exists()) {
            messageDiv.textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!";
            messageDiv.className = "message success";
            
            // ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => {
                window.location.href = "main.html";
            }, 1000);
        } else {
            messageDiv.textContent = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø¯Ø®ÙˆÙ„!";
            messageDiv.className = "message error";
            await auth.signOut();
        }
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
        
        if (error.code === 'auth/invalid-credential') {
            messageDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!";
        } else if (error.code === 'auth/too-many-requests') {
            messageDiv.textContent = "ØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¯Ø© Ù…Ø±Ø§Øª Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹";
        } else {
            messageDiv.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!";
        }
        messageDiv.className = "message error";
    }
});